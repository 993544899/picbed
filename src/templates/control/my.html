{% extends "layout/control.html" %}

{% block title %}个人中心{% endblock %}

{% block head %}
<style>
    #page {
        text-align: center;
    }
    .waterfall {
        -moz-column-count: auto;
        -webkit-column-count: auto;
        column-count: auto;
        -moz-column-width: 15em;
        -webkit-column-width: 15em;
        column-width: 15em;
        -moz-column-gap: 1em;
        -webkit-column-gap: 1em;
        column-gap: 1em;
    }
    .pin {
        margin: 0 0.125em 1em;
        /*
        padding: 1em;
        -moz-page-break-inside: avoid;
        -webkit-column-break-inside: avoid;
        break-inside: avoid;
        background: white;
        -moz-box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.12), 0 1px 2px 0 rgba(0, 0, 0, 0.24);
        -webkit-box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.12), 0 1px 2px 0 rgba(0, 0, 0, 0.24);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.12), 0 1px 2px 0 rgba(0, 0, 0, 0.24);
        */
    }
    .pin img {
        width: 100%;
        /*padding-bottom: 1em;*/
        margin-bottom: 0.5em;
        border-bottom: 0px solid #fff;
    }
    .pin img:hover {
        transform:scale({{ g.userinfo.ucfg_mypic_scale or 1|float }});
    }
    .pin .description {
        text-align: center;
        position: absolute;
    }
    body .my-layer .layui-layer-btn .layui-layer-btn0 {
        background: #FF5722;
        border-color: #FF5722;
        color: #fff;
    }
    body .my-layer .layui-layer-btn .layui-layer-btn2 {
        background: #01AAED;
        border-color: #01AAED;
        color: #fff;
    }
    #albums {
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="layui-container">
    <div class="layui-tab layui-tab-brief" lay-filter="tab">
        <ul class="layui-tab-title">
            <li class="layui-this" lay-id="profile">个人资料</li>
            <li lay-id="password">修改密码</li>
            <li lay-id="setting">用户设置<span class="layui-badge-dot"></span>
            </li>
            <li lay-id="picbed">我的图片</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <form lay-filter="profileForm" class="layui-form layui-form-pane">
                    <div class="layui-form-item">
                        <label class="layui-form-label">用户名</label>
                        <div class="layui-input-inline">
                            <input type="text" required="" autocomplete="off" value="{{ g.userinfo.username }}"
                                class="layui-input layui-disabled" disabled="">
                        </div>
                        <div class="layui-form-mid layui-word-aux">
                            {% if g.is_admin %}
                            <scan style="color: #5FB878;font-weight: bold;">你好，管理员！</scan>
                            {% endif %}
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">昵称</label>
                        <div class="layui-input-inline">
                            <input type="text" name="nickname" autocomplete="off" value="{{ g.userinfo.nickname }}"
                                placeholder="个性化的别名" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">头像</label>
                        <div class="layui-input-inline">
                            <input type="text" name="avatar" autocomplete="off" value="{{ g.userinfo.avatar }}"
                                placeholder="头像URL" class="layui-input">
                        </div>
                    </div>
                    {{ intpl("profile") }}
                    <div class="layui-form-item">
                        <button class="layui-btn" lay-filter="profile" lay-submit="">保存</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </form>
            </div>
            <div class="layui-tab-item">
                <form class="layui-form layui-form-pane">
                    <div class="layui-form-item">
                        <label class="layui-form-label">新密码</label>
                        <div class="layui-input-inline">
                            <input type="password" name="passwd" required="" lay-verify="required" autocomplete="off"
                                class="layui-input">
                        </div>
                        <div class="layui-form-mid layui-word-aux">至少6个字符</div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">确认密码</label>
                        <div class="layui-input-inline">
                            <input type="password" name="repasswd" required="" lay-verify="required" autocomplete="off"
                                class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <button class="layui-btn" lay-filter="passwd" lay-submit="">确认修改</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </form>
            </div>
            <div class="layui-tab-item">
                <blockquote class="layui-elem-quote">这是您在站点中的个性化设置，仅在个人登录后有效，不会影响到其他人！</blockquote>
                <form class="layui-form layui-form-pane" id="control" lay-filter="setting" autocomplete="off">
                    <div class="layui-form-item">
                        <label class="layui-form-label">背景图</label>
                        <div class="layui-input-block">
                            <input type="text" name="ucfg_bg_mg" value="{{ g.userinfo.ucfg_bg_mg }}"
                                placeholder="背景图地址，下拉可选择默认提供的背景图" autocomplete="off" class="layui-input"
                                list="bg_mg_defaults">
                            <datalist id="bg_mg_defaults">
                                <option value="https://open.saintic.com/api/bingPic">
                                <option value="{{ url_for('static', filename='img/bg1.jpg') }}">
                                <option value="{{ url_for('static', filename='img/bg2.jpg') }}">
                                <option value="{{ url_for('static', filename='img/bg3.jpg') }}">
                                <option value="{{ url_for('static', filename='img/bg4.jpg') }}">
                                <option value="{{ url_for('static', filename='img/bg5.jpg') }}">
                            </datalist>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">背景透明度</label>
                        <div class="layui-input-block">
                            <input type="number" step=0.1 min=0 max=1 name="ucfg_bg_ransparency"
                                value="{{ g.userinfo.ucfg_bg_ransparency }}" placeholder="背景透明度，0-1之间（值越大越透明），默认是：0.5，目前仅首页有效"
                                autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">图片放大度</label>
                        <div class="layui-input-block">
                            <input type="number" step=0.1 min=1 max=2 name="ucfg_mypic_scale"
                                value="{{ g.userinfo.ucfg_mypic_scale }}" placeholder="定义我的图片页面鼠标悬浮图片时放大的倍数，1-2之间，默认是1不放大"
                                autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">图片数量</label>
                        <div class="layui-input-block">
                            <input type="number" step=1 min=1 max=100 name="ucfg_mypic_limit"
                                value="{{ g.userinfo.ucfg_mypic_limit }}" placeholder="定义我的图片页面每次查询图床的数量，默认10"
                                autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    {{ intpl("usersetting") }}
                    <div class="layui-form-item">
                        <button class="layui-btn" lay-submit lay-filter="*">立即提交</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </form>
            </div>
            <div class="layui-tab-item">
                <div id="albums"></div>
                <div id="waterfall" class="waterfall"></div>
                <div id="page"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
{% include "ref/upload_show.html" %}
<script>
    layui.use(['picbed', 'laypage', 'flow', 'form', 'element', 'layer', 'laytpl', 'util'], function () {
        var $ = layui.jquery,
            picbed = layui.picbed,
            util = layui.util,
            flow = layui.flow,
            form = layui.form,
            layer = layui.layer,
            laytpl = layui.laytpl,
            element = layui.element,
            laypage = layui.laypage;
        //显示当前tab
        if (location.hash) {
            var layid = location.hash.replace(/^#!/, '').replace(/^#%21/, '').split('=')[0];
            element.tabChange('tab', layid);
        }
        //监听tab切换
        element.on('tab(tab)', function (data) {
            var othis = $(this),
                layid = othis.attr('lay-id');
            if (layid) {
                location.hash = '!' + layid;
            }
        });
        var curr = location.hash.replace('#!picbed=', ''),
            limit = parseInt("{{ request.args.limit or g.userinfo.ucfg_mypic_limit or 10 }}");
        //将所有图片数据提到"全局"
        var shaDatas = {};
        //获取我的图片流方法
        function get_pics(page, success) {
            var url = "{{ url_for('api.waterfall', sort='desc', is_mgr=request.args.is_mgr, album=request.args.album)|safe }}&limit=" + limit + "&page=" + page;
            picbed.ajax(url, function (res) {
                var html = res.data.map(function (img) {
                    img["ctime"] = util.toDateString(img.ctime * 1000);
                    img["is_control"] = true;
                    shaDatas[img.sha] = img;
                    return '<div class="pin"><img lay-src="' + img.src +'" data-sha="' + img.sha + '"></div>';
                }).join("");
                $("#waterfall").html(html);
                flow.lazyimg(); 
                typeof success === "function" && success(res);
                $("#waterfall").find(".pin img").on("click", function() {
                    var sha = $(this).data("sha"),
                        src = this.src;
                    laytpl(upload_show_tpl.innerHTML).render(shaDatas[sha], function(html){
                        layer.open({
                            type: 1,
                            title: false,
                            closeBtn: true,
                            area: document.body.clientWidth > 550 ? '550px' : 'auto',
                            maxHeight: '500px',
                            id: 'upload_show_area',
                            skin: 'my-layer',
                            shade: 0.1,
                            shadeClose: true,
                            btn: ['删除', '关闭', '原图'],
                            btnAlign: 'c',
                            content: html,
                            success: function(layero, indexo) {
                                element.render('tab');
                                if (shaDatas[sha]["status"] === 'deleted') {
                                    layero.children(".layui-layer-btn").children(".layui-layer-btn0").text("已删除");
                                }
                                $(layero).find('.upload_show_copy').on('click', function() {
                                    var copyId = $(this).data('copyid');
                                    picbed.Clipboard.copy($(copyId).text());
                                });
                            },
                            yes: function(index, layero){
                                //按钮【删除】的回调
                                if (layero.children(".layui-layer-btn").children(".layui-layer-btn0").text() === "确认删除") {
                                    picbed.ajax("{{ url_for('api.shamgr', sha='') }}" + sha, function(res) {
                                        layer.msg("已删除", {icon:1});
                                        shaDatas[sha]["status"] = "deleted";
                                        layero.children(".layui-layer-btn").children(".layui-layer-btn0").text("已删除");
                                    }, {
                                        method: 'delete'
                                    });
                                } else {
                                    if (layero.children(".layui-layer-btn").children(".layui-layer-btn0").text() === "删除") {
                                        layero.children(".layui-layer-btn").children(".layui-layer-btn0").text("确认删除");
                                    }
                                }
                            },
                            btn2: function(index, layero){
                                //按钮【关闭】的回调
                                layer.close(index);
                            },
                            btn3: function(index, layero) {
                                //按钮【原图】的回调
                                var id = "jump-" + sha,
                                    a = document.createElement("a");
                                a.style.display='none';
                                a.setAttribute("href", src);
                                a.setAttribute("target", "_blank");
                                a.setAttribute("id", id);
                                if(!document.getElementById(id)) {
                                    document.body.appendChild(a);
                                }
                                a.click();
                                return false;
                            },
                        });
                    });
                });
            }, {
                msgprefix: false,
                fail: function(res) {
                    $("#waterfall").text("无数据");
                }
            });
        }
        //初始加载图片
        get_pics(curr, function (res) {
            laypage.render({
                elem: 'page',
                count: res.count,
                limit: limit,
                hash: 'picbed',
                curr: curr, //起始页
                jump: function (obj, first) {
                    if (!first) {
                        get_pics(obj.curr);
                    } else {
                        //初始加载相册列表
                        var uri = "{{ (url_for('front.my', is_mgr=request.args.is_mgr) + '&album=')|safe if request.args.is_mgr else url_for('front.my', album='') }}";
                        var html = '<a href="' + uri.replace("?album=", "").replace("&album=", "") + '#!picbed"><span class="layui-badge">所有图片</span></a>&nbsp;&nbsp;';
                        html += res.albums.map(function(album) {
                            return '<a href="' + uri + album + '#!picbed"><span class="layui-badge layui-bg-green">' +  album + '</span></a>&nbsp;&nbsp;';
                        }).join('');
                        $("#albums").html(html);
                    }
                }
            });
        });
        //监听资料修改
        form.on('submit(profile)', function(data){
            var post = data.field;
            delete post.token;
            picbed.ajax("{{ url_for('api.my', Action='updateProfile') }}", function(res) {
                layer.msg("已修改资料", {icon:1});
                if (post.avatar) {
                    $("#avatar").attr("src", post.avatar);
                }
                if (post.nickname) {
                    $("#nickname").text(post.nickname);
                }
            }, {
                method: 'PUT',
                data: post
            });
            return false;
        });
        //监听密码修改
        form.on('submit(passwd)', function(data){
            picbed.ajax("{{ url_for('api.my', Action='updatePassword') }}", function(res) {
                layer.msg("已修改密码", {icon:1});
            }, {
                method: 'PUT',
                data: data.field
            });
            return false;
        });
        //监听token动作
        $("#createToken").on("click", function() {
            picbed.ajax("{{ url_for('api.token', Action='create') }}", function(res) {
                layer.msg("Token创建成功", {icon:1});
            　　$("#token").removeAttr("readonly");
                form.val("profileForm", {token: res.token});
                $("#token").attr("readonly","readonly");
                $("#yesToken").removeClass("layui-hide");
                $("#yesToken").addClass("layui-show");
                $("#noToken").removeClass("layui-show");
                $("#noToken").addClass("layui-hide");
            })
        });
        $("#revokeToken").on("click", function() {
            picbed.ajax("{{ url_for('api.token', Action='revoke') }}", function(res) {
                layer.msg("Token已销毁", {icon:1});
            　　$("#token").removeAttr("readonly");
                form.val("profileForm", {token: ''});
                $("#token").attr("readonly","readonly");
                $("#yesToken").removeClass("layui-show");
                $("#yesToken").addClass("layui-hide");
                $("#noToken").removeClass("layui-hide");
                $("#noToken").addClass("layui-show");
            })
        });
        $("#resetToken").on("click", function() {
            picbed.ajax("{{ url_for('api.token', Action='reset') }}", function(res) {
                layer.msg("Token重置成功", {icon:1});
            　　$("#token").removeAttr("readonly");
                form.val("profileForm", {token: res.token});
                $("#token").attr("readonly","readonly");
                $("#yesToken").removeClass("layui-hide");
                $("#yesToken").addClass("layui-show");
                $("#noToken").removeClass("layui-show");
                $("#noToken").addClass("layui-hide");
            })
        });
        $("#copyToken").on("click", function() {
            picbed.Clipboard.copy($("#token").val());
        });
        //监听相册修改
        form.on('submit(updateAlbumSubmit)', function(data){
            var album = data.field.album,
                sha = data.field.sha;
            picbed.ajax("{{ url_for('api.shamgr', sha='') }}" + sha, function(res) {
                layer.msg("已修改", {icon:1});
                shaDatas[sha]["album"] = album;

            }, {
                method: "PUT",
                data: {Action: "updateAlbum", album: album}
            });
            return false;
        });
        //监听用户设置
        form.on('submit(*)', function(data){
            console.log(data.field);
            if (document.forms['control'].checkValidity() === false) {
                layer.msg("发现部分参数不合法",{icon:0});
                document.forms['control'].reportValidity();
                return false;
            }
            picbed.ajax("{{ url_for('api.my', Action='updateUserCfg') }}", function(res) {
                if (res.code === 0) {
                    layer.msg("已修用户改配置", {icon:1});
                } else {
                    layer.msg(res.msg, {icon:0});
                }
            }, {
                method: "PUT",
                data: data.field
            });
            return false;
        });
    });
</script>
{% endblock %}